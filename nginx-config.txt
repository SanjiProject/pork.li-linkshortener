location / {
    try_files $uri $uri/ @fallback;
}

location @fallback {
    rewrite ^ /404.php last;
}


location ~ ^/(config|includes)/ {
    deny all;
    return 404;
}

# Block sensitive files
location ~ /\.(env|htaccess|gitignore|ini|log|conf|sql)$ {
    deny all;
    return 404;
}

# Allow system directories to work normally
location ~ ^/(api|public|dashboard|admin|settings)/ {
    try_files $uri $uri/ /404.php;
}

# Clean URLs for login/register
location = /login {
    try_files $uri /login.php;
}

location = /register {
    try_files $uri /register.php;
}

# Short link handler - only for single path segments that aren't system paths
location ~ ^/([a-zA-Z0-9_-]+)/?$ {
    try_files $uri /redirect.php?code=$1;
}
